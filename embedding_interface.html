<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI文本嵌入生成器</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen font-inter">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-vector-square text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">AI文本嵌入生成器</h1>
                        <p class="text-sm text-gray-500">基于智谱GLM嵌入模型</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="apiStatus" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">检查中...</span>
                    </div>
                    <button id="settingsBtn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab Navigation -->
        <div class="mb-8">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button class="tab-btn active" data-tab="single">
                    <i class="fas fa-file-text mr-2"></i>
                    单文本嵌入
                </button>
                <button class="tab-btn" data-tab="batch">
                    <i class="fas fa-layer-group mr-2"></i>
                    批量嵌入
                </button>
                <button class="tab-btn" data-tab="similarity">
                    <i class="fas fa-search mr-2"></i>
                    相似度计算
                </button>
                <button class="tab-btn" data-tab="search">
                    <i class="fas fa-search-plus mr-2"></i>
                    相似文本搜索
                </button>
            </nav>
        </div>

        <!-- Single Text Embedding Tab -->
        <div id="singleTab" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Input Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-edit text-blue-500 mr-2"></i>
                        文本输入
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">输入文本</label>
                            <textarea 
                                id="singleText" 
                                rows="6" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="请输入要生成嵌入向量的文本..."
                            ></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">嵌入模型</label>
                            <select id="singleModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="embedding-3">embedding-3 (推荐)</option>
                                <option value="embedding-2">embedding-2</option>
                            </select>
                        </div>
                        
                        <button 
                            id="generateSingleBtn" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-medium"
                        >
                            <i class="fas fa-magic mr-2"></i>
                            生成嵌入向量
                        </button>
                    </div>
                </div>

                <!-- Result Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-chart-line text-green-500 mr-2"></i>
                        嵌入结果
                    </h2>
                    
                    <div id="singleResult" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-vector-square text-4xl mb-4 opacity-50"></i>
                            <p>请输入文本并点击生成按钮</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Embedding Tab -->
        <div id="batchTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Input Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list text-blue-500 mr-2"></i>
                        批量文本输入
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">文本列表 (每行一个)</label>
                            <textarea 
                                id="batchTexts" 
                                rows="8" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="人工智能是计算机科学的一个分支&#10;机器学习是人工智能的子领域&#10;深度学习基于神经网络&#10;自然语言处理处理人类语言"
                            ></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">嵌入模型</label>
                            <select id="batchModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="embedding-3">embedding-3 (推荐)</option>
                                <option value="embedding-2">embedding-2</option>
                            </select>
                        </div>
                        
                        <button 
                            id="generateBatchBtn" 
                            class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 px-4 rounded-lg hover:from-green-600 hover:to-teal-700 transition-all duration-200 font-medium"
                        >
                            <i class="fas fa-layer-group mr-2"></i>
                            批量生成嵌入
                        </button>
                    </div>
                </div>

                <!-- Result Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                        批量结果
                    </h2>
                    
                    <div id="batchResult" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-layer-group text-4xl mb-4 opacity-50"></i>
                            <p>请输入文本列表并点击生成按钮</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Similarity Calculation Tab -->
        <div id="similarityTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Input Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-balance-scale text-blue-500 mr-2"></i>
                        相似度计算
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">第一个文本</label>
                            <textarea 
                                id="text1" 
                                rows="4" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="请输入第一个文本..."
                            ></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">第二个文本</label>
                            <textarea 
                                id="text2" 
                                rows="4" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="请输入第二个文本..."
                            ></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">嵌入模型</label>
                            <select id="similarityModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="embedding-3">embedding-3 (推荐)</option>
                                <option value="embedding-2">embedding-2</option>
                            </select>
                        </div>
                        
                        <button 
                            id="calculateSimilarityBtn" 
                            class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white py-3 px-4 rounded-lg hover:from-purple-600 hover:to-pink-700 transition-all duration-200 font-medium"
                        >
                            <i class="fas fa-calculator mr-2"></i>
                            计算相似度
                        </button>
                    </div>
                </div>

                <!-- Result Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                        相似度结果
                    </h2>
                    
                    <div id="similarityResult" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-balance-scale text-4xl mb-4 opacity-50"></i>
                            <p>请输入两个文本并点击计算按钮</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Similar Text Search Tab -->
        <div id="searchTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Input Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-search text-blue-500 mr-2"></i>
                        相似文本搜索
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">查询文本</label>
                            <textarea 
                                id="queryText" 
                                rows="3" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="请输入查询文本..."
                            ></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">候选文本 (每行一个)</label>
                            <textarea 
                                id="candidateTexts" 
                                rows="6" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="深度学习是机器学习的一个子领域&#10;今天天气很好&#10;神经网络是人工智能的重要技术&#10;我喜欢吃苹果&#10;自然语言处理属于AI领域"
                            ></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">嵌入模型</label>
                                <select id="searchModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="embedding-3">embedding-3 (推荐)</option>
                                    <option value="embedding-2">embedding-2</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">返回数量</label>
                                <input 
                                    type="number" 
                                    id="topK" 
                                    value="5" 
                                    min="1" 
                                    max="20" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                        </div>
                        
                        <button 
                            id="searchSimilarBtn" 
                            class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 px-4 rounded-lg hover:from-orange-600 hover:to-red-700 transition-all duration-200 font-medium"
                        >
                            <i class="fas fa-search-plus mr-2"></i>
                            搜索相似文本
                        </button>
                    </div>
                </div>

                <!-- Result Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list-ol text-orange-500 mr-2"></i>
                        搜索结果
                    </h2>
                    
                    <div id="searchResult" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-search-plus text-4xl mb-4 opacity-50"></i>
                            <p>请输入查询文本和候选文本并点击搜索按钮</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">处理中...</h3>
                <p id="loadingText" class="text-gray-600">正在生成嵌入向量</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">设置</h3>
                <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API服务器地址</label>
                    <input 
                        type="text" 
                        id="apiUrl" 
                        value="http://localhost:5000" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelSettingsBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                    <button id="saveSettingsBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">保存</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors;
        }
        .tab-btn.active {
            @apply text-blue-600 border-blue-600;
        }
        .tab-content {
            @apply hidden;
        }
        .tab-content.active {
            @apply block;
        }
        .similarity-bar {
            @apply h-4 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full;
        }
        .similarity-indicator {
            @apply absolute top-0 w-1 h-4 bg-white border-2 border-gray-800 rounded-full transform -translate-x-1/2;
        }
    </style>

    <script>
        // Global variables
        let apiUrl = 'http://localhost:5000';
        
        // DOM elements
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const loadingModal = document.getElementById('loadingModal');
        const loadingText = document.getElementById('loadingText');
        const settingsModal = document.getElementById('settingsModal');
        const apiStatus = document.getElementById('apiStatus');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeEventListeners();
            checkApiStatus();
            loadSettings();
        });

        // Tab functionality
        function initializeTabs() {
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            // Update tab buttons
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });

            // Update tab contents
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId + 'Tab') {
                    content.classList.add('active');
                }
            });
        }

        // Event listeners
        function initializeEventListeners() {
            // Single embedding
            document.getElementById('generateSingleBtn').addEventListener('click', generateSingleEmbedding);
            
            // Batch embedding
            document.getElementById('generateBatchBtn').addEventListener('click', generateBatchEmbedding);
            
            // Similarity calculation
            document.getElementById('calculateSimilarityBtn').addEventListener('click', calculateSimilarity);
            
            // Similar text search
            document.getElementById('searchSimilarBtn').addEventListener('click', searchSimilarTexts);
            
            // Settings
            document.getElementById('settingsBtn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
            document.getElementById('closeSettingsBtn').addEventListener('click', () => settingsModal.classList.add('hidden'));
            document.getElementById('cancelSettingsBtn').addEventListener('click', () => settingsModal.classList.add('hidden'));
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        }

        // API functions
        async function makeApiRequest(endpoint, data) {
            try {
                const response = await fetch(`${apiUrl}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Single embedding
        async function generateSingleEmbedding() {
            const text = document.getElementById('singleText').value.trim();
            const model = document.getElementById('singleModel').value;
            
            if (!text) {
                alert('请输入文本');
                return;
            }
            
            showLoading('正在生成嵌入向量...');
            
            try {
                const result = await makeApiRequest('/get_text_embeddings', {
                    input_text: text,
                    model: model
                });
                
                displaySingleResult(result, text, model);
            } catch (error) {
                displayError('singleResult', '生成嵌入向量失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displaySingleResult(result, text, model) {
            const container = document.getElementById('singleResult');
            
            if (result.success && result.data && result.data.length > 0) {
                const embedding = result.data[0].embedding;
                const usage = result.usage || {};
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="font-medium text-green-800">嵌入向量生成成功</span>
                            </div>
                            <div class="text-sm text-green-700">
                                <p><strong>文本:</strong> ${text.substring(0, 100)}${text.length > 100 ? '...' : ''}</p>
                                <p><strong>模型:</strong> ${model}</p>
                                <p><strong>向量维度:</strong> ${embedding.length}</p>
                                <p><strong>Token使用:</strong> ${usage.total_tokens || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-2">向量预览 (前10个值)</h4>
                            <div class="bg-white p-3 rounded border font-mono text-sm">
                                [${embedding.slice(0, 10).map(v => v.toFixed(6)).join(', ')}...]
                            </div>
                        </div>
                        
                        <button onclick="downloadEmbedding('${text}', ${JSON.stringify(embedding)}, '${model}')" 
                                class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            下载嵌入向量
                        </button>
                    </div>
                `;
            } else {
                displayError('singleResult', result.error || '生成嵌入向量失败');
            }
        }

        // Batch embedding
        async function generateBatchEmbedding() {
            const textsInput = document.getElementById('batchTexts').value.trim();
            const model = document.getElementById('batchModel').value;
            
            if (!textsInput) {
                alert('请输入文本列表');
                return;
            }
            
            const texts = textsInput.split('\n').filter(t => t.trim());
            if (texts.length === 0) {
                alert('请输入有效的文本列表');
                return;
            }
            
            showLoading(`正在批量生成 ${texts.length} 个文本的嵌入向量...`);
            
            try {
                const result = await makeApiRequest('/get_batch_embeddings', {
                    texts: texts,
                    model: model
                });
                
                displayBatchResult(result, texts, model);
            } catch (error) {
                displayError('batchResult', '批量生成嵌入向量失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayBatchResult(result, texts, model) {
            const container = document.getElementById('batchResult');
            
            if (result.success && result.embeddings) {
                const embeddings = result.embeddings;
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="font-medium text-green-800">批量嵌入向量生成成功</span>
                            </div>
                            <div class="text-sm text-green-700">
                                <p><strong>文本数量:</strong> ${result.count}</p>
                                <p><strong>模型:</strong> ${model}</p>
                                <p><strong>向量维度:</strong> ${result.dimension}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">文本列表</h4>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${texts.map((text, index) => `
                                    <div class="bg-white p-3 rounded border">
                                        <div class="text-sm font-medium text-gray-900 mb-1">${index + 1}. ${text.substring(0, 80)}${text.length > 80 ? '...' : ''}</div>
                                        <div class="text-xs text-gray-500 font-mono">
                                            向量: [${embeddings[index].slice(0, 3).map(v => v.toFixed(4)).join(', ')}...]
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button onclick="downloadBatchEmbeddings(${JSON.stringify(texts)}, ${JSON.stringify(embeddings)}, '${model}')" 
                                class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            下载批量嵌入向量
                        </button>
                    </div>
                `;
            } else {
                displayError('batchResult', result.error || '批量生成嵌入向量失败');
            }
        }

        // Similarity calculation
        async function calculateSimilarity() {
            const text1 = document.getElementById('text1').value.trim();
            const text2 = document.getElementById('text2').value.trim();
            const model = document.getElementById('similarityModel').value;
            
            if (!text1 || !text2) {
                alert('请输入两个文本');
                return;
            }
            
            showLoading('正在计算相似度...');
            
            try {
                const result = await makeApiRequest('/calculate_text_similarity', {
                    text1: text1,
                    text2: text2,
                    model: model
                });
                
                displaySimilarityResult(result);
            } catch (error) {
                displayError('similarityResult', '计算相似度失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displaySimilarityResult(result) {
            const container = document.getElementById('similarityResult');
            
            if (result.success) {
                const similarity = result.similarity;
                const percentage = (similarity * 100).toFixed(2);
                const level = result.interpretation.level;
                
                let colorClass = 'text-red-600';
                let bgClass = 'bg-red-50 border-red-200';
                if (similarity > 0.7) {
                    colorClass = 'text-green-600';
                    bgClass = 'bg-green-50 border-green-200';
                } else if (similarity > 0.4) {
                    colorClass = 'text-yellow-600';
                    bgClass = 'bg-yellow-50 border-yellow-200';
                }
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="${bgClass} border rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-chart-line ${colorClass} mr-2"></i>
                                <span class="font-medium ${colorClass}">相似度计算完成</span>
                            </div>
                            <div class="text-sm ${colorClass}">
                                <p><strong>相似度分数:</strong> ${similarity.toFixed(4)} (${percentage}%)</p>
                                <p><strong>相似度等级:</strong> ${level}</p>
                                <p><strong>模型:</strong> ${result.model}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">相似度可视化</h4>
                            <div class="relative">
                                <div class="similarity-bar"></div>
                                <div class="similarity-indicator" style="left: ${percentage}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h5 class="font-medium text-blue-900 mb-2">文本1</h5>
                                <p class="text-sm text-blue-800">${result.text1.substring(0, 100)}${result.text1.length > 100 ? '...' : ''}</p>
                            </div>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <h5 class="font-medium text-purple-900 mb-2">文本2</h5>
                                <p class="text-sm text-purple-800">${result.text2.substring(0, 100)}${result.text2.length > 100 ? '...' : ''}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                displayError('similarityResult', result.error || '计算相似度失败');
            }
        }

        // Similar text search
        async function searchSimilarTexts() {
            const queryText = document.getElementById('queryText').value.trim();
            const candidateTextsInput = document.getElementById('candidateTexts').value.trim();
            const model = document.getElementById('searchModel').value;
            const topK = parseInt(document.getElementById('topK').value);
            
            if (!queryText || !candidateTextsInput) {
                alert('请输入查询文本和候选文本');
                return;
            }
            
            const candidateTexts = candidateTextsInput.split('\n').filter(t => t.trim());
            if (candidateTexts.length === 0) {
                alert('请输入有效的候选文本列表');
                return;
            }
            
            showLoading('正在搜索相似文本...');
            
            try {
                const result = await makeApiRequest('/find_similar_texts', {
                    query_text: queryText,
                    candidate_texts: candidateTexts,
                    model: model,
                    top_k: topK
                });
                
                displaySearchResult(result);
            } catch (error) {
                displayError('searchResult', '搜索相似文本失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displaySearchResult(result) {
            const container = document.getElementById('searchResult');
            
            if (result.success && result.results) {
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-search text-green-500 mr-2"></i>
                                <span class="font-medium text-green-800">相似文本搜索完成</span>
                            </div>
                            <div class="text-sm text-green-700">
                                <p><strong>查询:</strong> ${result.query.substring(0, 50)}${result.query.length > 50 ? '...' : ''}</p>
                                <p><strong>候选文本数量:</strong> ${result.total_candidates}</p>
                                <p><strong>返回结果数量:</strong> ${result.top_k}</p>
                                <p><strong>模型:</strong> ${result.model}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">搜索结果 (按相似度排序)</h4>
                            <div class="space-y-3">
                                ${result.results.map((item, index) => {
                                    const percentage = (item.similarity * 100).toFixed(1);
                                    let colorClass = 'border-red-200 bg-red-50';
                                    if (item.similarity > 0.7) {
                                        colorClass = 'border-green-200 bg-green-50';
                                    } else if (item.similarity > 0.4) {
                                        colorClass = 'border-yellow-200 bg-yellow-50';
                                    }
                                    
                                    return `
                                        <div class="border ${colorClass} rounded-lg p-3">
                                            <div class="flex justify-between items-start mb-2">
                                                <span class="text-sm font-medium text-gray-900">#${index + 1}</span>
                                                <span class="text-sm font-bold text-gray-700">${percentage}%</span>
                                            </div>
                                            <p class="text-sm text-gray-800">${item.text}</p>
                                            <div class="mt-2">
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                displayError('searchResult', result.error || '搜索相似文本失败');
            }
        }

        // Utility functions
        function showLoading(message) {
            loadingText.textContent = message;
            loadingModal.classList.remove('hidden');
        }

        function hideLoading() {
            loadingModal.classList.add('hidden');
        }

        function displayError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                        <span class="font-medium text-red-800">错误</span>
                    </div>
                    <p class="text-sm text-red-700 mt-2">${message}</p>
                </div>
            `;
        }

        // Download functions
        function downloadEmbedding(text, embedding, model) {
            const data = {
                text: text,
                embedding: embedding,
                model: model,
                dimension: embedding.length,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `embedding_${model}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadBatchEmbeddings(texts, embeddings, model) {
            const data = {
                model: model,
                count: texts.length,
                dimension: embeddings.length > 0 ? embeddings[0].length : 0,
                timestamp: new Date().toISOString(),
                data: texts.map((text, index) => ({
                    text: text,
                    embedding: embeddings[index]
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `batch_embeddings_${model}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Settings functions
        function loadSettings() {
            const savedUrl = localStorage.getItem('apiUrl');
            if (savedUrl) {
                apiUrl = savedUrl;
                document.getElementById('apiUrl').value = savedUrl;
            }
        }

        function saveSettings() {
            const newUrl = document.getElementById('apiUrl').value.trim();
            if (newUrl) {
                apiUrl = newUrl;
                localStorage.setItem('apiUrl', newUrl);
                settingsModal.classList.add('hidden');
                checkApiStatus();
            }
        }

        // API status check
        async function checkApiStatus() {
            try {
                const response = await fetch(`${apiUrl}/test_embedding_api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.connection_test) {
                        updateApiStatus(true, '连接正常');
                    } else {
                        updateApiStatus(false, '连接失败');
                    }
                } else {
                    updateApiStatus(false, '服务器错误');
                }
            } catch (error) {
                updateApiStatus(false, '无法连接');
            }
        }

        function updateApiStatus(isOnline, message) {
            const statusDot = apiStatus.querySelector('.w-2');
            const statusText = apiStatus.querySelector('span');
            
            if (isOnline) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full';
                statusText.textContent = message;
                statusText.className = 'text-sm text-green-600';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
                statusText.textContent = message;
                statusText.className = 'text-sm text-red-600';
            }
        }

        // Check API status every 30 seconds
        setInterval(checkApiStatus, 30000);
    </script>
</body>
</html>
